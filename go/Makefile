# TinyTroupe Go Makefile

.PHONY: build test clean demo lint deps help

# Go parameters
GOCMD=go
GOBUILD=$(GOCMD) build
GOCLEAN=$(GOCMD) clean
GOTEST=$(GOCMD) test
GOGET=$(GOCMD) get
GOMOD=$(GOCMD) mod
GOFMT=gofmt
GOVET=$(GOCMD) vet

# Build targets
DEMO_BINARY=./bin/demo
DEMO_SOURCE=./cmd/demo
EXAMPLES_BINARY=./bin/agent_creation
EXAMPLES_SOURCE=./examples

# Default target
all: deps test build

## help: Display this help message
help:
	@echo "Available targets:"
	@grep -E '^##.*:' $(MAKEFILE_LIST) | sed 's/##\s*\([^:]*\):\s*\(.*\)/  \1: \2/'

## deps: Download dependencies
deps:
	$(GOMOD) download
	$(GOMOD) tidy

## build: Build all binaries
build: deps
	mkdir -p bin
	$(GOBUILD) -o $(DEMO_BINARY) $(DEMO_SOURCE)
	$(GOBUILD) -o $(EXAMPLES_BINARY) examples/agent_creation.go
	$(GOBUILD) -o ./bin/simple_chat examples/simple_chat.go
	$(GOBUILD) -o ./bin/agent_validation examples/agent_validation.go
	$(GOBUILD) -o ./bin/product_brainstorming examples/product_brainstorming.go
	$(GOBUILD) -o ./bin/synthetic_data_generation examples/synthetic_data_generation.go
	$(GOBUILD) -o ./bin/ab_testing examples/ab_testing.go
	$(GOBUILD) -o ./bin/simple_openai_example examples/simple_openai_example.go
	$(GOBUILD) -o ./bin/document_creation examples/document_creation.go

## test: Run tests
test:
	$(GOTEST) -v ./pkg/... ./cmd/...

## test-coverage: Run tests with coverage
test-coverage:
	$(GOTEST) -v -coverprofile=coverage.out ./pkg/... ./cmd/...
	$(GOCMD) tool cover -html=coverage.out -o coverage.html
	@echo "Coverage report generated: coverage.html"

## lint: Run linters
lint:
	$(GOFMT) -l -s .
	$(GOVET) ./...

## format: Format code
format:
	$(GOFMT) -l -s -w .

## examples: Run all example programs
examples: build
	@echo "=== Running TinyTroupe Go Examples ==="
	@echo ""
	@echo "1. Agent Creation Example:"
	$(EXAMPLES_BINARY)
	@echo ""
	@echo "2. Simple Chat Example:"
	./bin/simple_chat
	@echo ""
	@echo "3. Agent Validation Example:"
	./bin/agent_validation
	@echo ""
	@echo "4. Product Brainstorming Example:"
	./bin/product_brainstorming
	@echo ""
	@echo "5. Synthetic Data Generation Example:"
	./bin/synthetic_data_generation
	@echo ""
	@echo "6. A/B Testing Example:"
	./bin/ab_testing
	@echo ""
	@echo "=== All Examples Complete ==="

## demo: Run the demo (requires OPENAI_API_KEY)
demo: build
	@if [ -z "$(OPENAI_API_KEY)" ]; then \
		echo "Error: OPENAI_API_KEY environment variable is required"; \
		echo "Please set it with: export OPENAI_API_KEY=your_key_here"; \
		exit 1; \
	fi
	$(DEMO_BINARY)

## clean: Clean build artifacts
clean:
	$(GOCLEAN)
	rm -rf bin/
	rm -f coverage.out coverage.html

## check: Run all checks (format, lint, test)
check: format lint test

## init: Initialize project dependencies
init:
	$(GOMOD) init github.com/atsentia/tinytroupe-go || true
	$(GOGET) github.com/sashabaranov/go-openai

## docker-build: Build Docker image
docker-build:
	docker build -t tinytroupe-go .

## docker-run: Run Docker container (requires OPENAI_API_KEY)
docker-run:
	docker run --rm -e OPENAI_API_KEY=$(OPENAI_API_KEY) tinytroupe-go

## analyze-deps: Analyze dependencies for a module (usage: make analyze-deps MODULE=pkg/agent)
analyze-deps:
	@if [ -z "$(MODULE)" ]; then \
		echo "Usage: make analyze-deps MODULE=pkg/module-name"; \
		echo "Example: make analyze-deps MODULE=pkg/agent"; \
		exit 1; \
	fi
	go run cmd/analyze-deps/analyze-deps.go $(MODULE)

## compare-apis: Compare APIs between two modules (usage: make compare-apis OLD=pkg/old NEW=pkg/new)
compare-apis:
	@if [ -z "$(OLD)" ] || [ -z "$(NEW)" ]; then \
		echo "Usage: make compare-apis OLD=pkg/old-module NEW=pkg/new-module"; \
		echo "Example: make compare-apis OLD=pkg/agent NEW=pkg/agent_v2"; \
		exit 1; \
	fi
	go run cmd/compare-apis/compare-apis.go $(OLD) $(NEW)

## migration-status: Show migration status for all modules
migration-status:
	@echo "üìä TinyTroupe Go Migration Status"
	@echo "=================================="
	@echo ""
	@echo "‚úÖ Phase 0 (Complete):"
	@echo "  ‚Ä¢ pkg/agent"
	@echo "  ‚Ä¢ pkg/config"
	@echo "  ‚Ä¢ pkg/environment"
	@echo "  ‚Ä¢ pkg/memory"
	@echo "  ‚Ä¢ pkg/openai"
	@echo ""
	@echo "üÜï Phase 1 (Foundation):"
	@echo "  ‚Ä¢ pkg/control - Interface defined"
	@echo "  ‚Ä¢ pkg/factory - Complete"
	@echo "  ‚Ä¢ pkg/utils - Complete"
	@echo "  ‚Ä¢ pkg/validation - Complete"
	@echo ""
	@echo "üöß Phase 2 (Advanced):"
	@echo "  ‚Ä¢ pkg/enrichment - Placeholder"
	@echo "  ‚Ä¢ pkg/extraction - Placeholder"
	@echo "  ‚Ä¢ pkg/tools - Placeholder"
	@echo "  ‚Ä¢ pkg/profiling - Placeholder"
	@echo ""
	@echo "‚è≥ Phase 3 (UX):"
	@echo "  ‚Ä¢ pkg/ui - Placeholder"
	@echo "  ‚Ä¢ pkg/steering - Placeholder"
	@echo "  ‚Ä¢ pkg/experimentation - Placeholder"

# Development targets
.PHONY: dev-setup
dev-setup: deps
	@echo "Development environment setup complete"
	@echo "Run 'make help' to see available commands"